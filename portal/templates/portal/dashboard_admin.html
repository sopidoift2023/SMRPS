{% extends "portal/base.html" %}

{% block title %}School Admin Dashboard - Management{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid mt-4" style="max-width: 1400px;">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="mb-1"><i class="fas fa-school"></i> School Administration</h2>
            <p class="text-muted">{{ request.user.school.name }} | <span class="badge bg-info">{{ total_students }}
                    Students</span></p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{% url 'portal:dashboard' %}" class="btn btn-outline-primary">
                <i class="fas fa-home"></i> Back to Home
            </a>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer"></div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="teachers-tab" data-bs-toggle="tab" data-bs-target="#teachersTab"
                type="button" role="tab">
                <i class="fas fa-chalkboard-user"></i> Teachers
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="subjects-tab" data-bs-toggle="tab" data-bs-target="#subjectsTab" type="button"
                role="tab">
                <i class="fas fa-book"></i> Subjects
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="classes-tab" data-bs-toggle="tab" data-bs-target="#classesTab" type="button"
                role="tab">
                <i class="fas fa-building"></i> Classes
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="assignments-tab" data-bs-toggle="tab" data-bs-target="#assignmentsTab"
                type="button" role="tab">
                <i class="fas fa-link"></i> Assignments
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#resultsTab" type="button"
                role="tab">
                <i class="fas fa-file-pdf"></i> Results PDF
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="sessions-tab" data-bs-toggle="tab" data-bs-target="#sessionsTab" type="button"
                role="tab">
                <i class="fas fa-calendar-alt"></i> Sessions
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="students-mgmt-tab" data-bs-toggle="tab" data-bs-target="#studentsMgmtTab"
                type="button" role="tab">
                <i class="fas fa-user-graduate"></i> Add Student
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settingsTab" type="button"
                role="tab">
                <i class="fas fa-cog"></i> Settings
            </button>
        </li>
    </ul>


    <!-- Tab Content -->
    <div class="tab-content">
        <!-- TEACHERS TAB -->
        <div class="tab-pane fade show active" id="teachersTab" role="tabpanel">
            <div class="row">
                <!-- Create Teacher Form -->
                <div class="col-md-5">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-plus"></i> Add New Teacher</h5>
                        </div>
                        <div class="card-body">
                            <form id="createTeacherForm" class="needs-validation">
                                <div class="mb-3">
                                    <label for="teacherUsername" class="form-label">Username *</label>
                                    <input type="text" class="form-control" id="teacherUsername" required>
                                    <small class="text-muted">Unique identifier for login</small>
                                </div>
                                <div class="mb-3">
                                    <label for="teacherFirstName" class="form-label">First Name *</label>
                                    <input type="text" class="form-control" id="teacherFirstName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="teacherMiddleName" class="form-label">Middle Name</label>
                                    <input type="text" class="form-control" id="teacherMiddleName">
                                </div>
                                <div class="mb-3">
                                    <label for="teacherLastName" class="form-label">Last Name *</label>
                                    <input type="text" class="form-control" id="teacherLastName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="teacherStaffId" class="form-label">Staff ID *</label>
                                    <input type="text" class="form-control" id="teacherStaffId" required>
                                </div>
                                <div class="mb-3">
                                    <label for="teacherPassword" class="form-label">Password *</label>
                                    <input type="password" class="form-control" id="teacherPassword" required>
                                    <small class="text-muted">Teacher can change after login</small>
                                </div>
                                <div class="mb-3">
                                    <label for="teacherPhone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="teacherPhone">
                                </div>
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-save"></i> Create Teacher
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Teachers List -->
                <div class="col-md-7">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Teachers in School</h5>
                        </div>
                        <div class="card-body">
                            <div id="teachersLoading" class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading teachers...
                            </div>
                            <div class="table-responsive" id="teachersTableContainer" style="display: none;">
                                <table class="table table-hover" id="teachersList">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Name</th>
                                            <th>Username</th>
                                            <th>Staff ID</th>
                                            <th>Phone</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SUBJECTS TAB -->
        <div class="tab-pane fade" id="subjectsTab" role="tabpanel">
            <div class="row">
                <div class="col-md-5">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-plus"></i> Add Subject</h5>
                        </div>
                        <div class="card-body">
                            <form id="createSubjectForm">
                                <div class="mb-3">
                                    <label for="subjectName" class="form-label">Subject Name *</label>
                                    <input type="text" class="form-control" id="subjectName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="subjectCode" class="form-label">Subject Code</label>
                                    <input type="text" class="form-control" id="subjectCode" placeholder="e.g., MTH101">
                                </div>
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-save"></i> Create Subject
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-7">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Subjects</h5>
                        </div>
                        <div class="card-body">
                            <div id="subjectsLoading" class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading subjects...
                            </div>
                            <div class="table-responsive" id="subjectsTableContainer" style="display: none;">
                                <table class="table table-hover" id="subjectsList">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Name</th>
                                            <th>Code</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CLASSES TAB -->
        <div class="tab-pane fade" id="classesTab" role="tabpanel">
            <div class="row">
                <div class="col-md-5">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-plus"></i> Add Class</h5>
                        </div>
                        <div class="card-body">
                            <form id="createClassForm">
                                <div class="mb-3">
                                    <label for="className" class="form-label">Class Name *</label>
                                    <input type="text" class="form-control" id="className" placeholder="e.g., JSS1, SS3"
                                        required>
                                </div>
                                <div class="mb-3">
                                    <label for="formTeacher" class="form-label">Form Teacher</label>
                                    <select class="form-select" id="formTeacher">
                                        <option value="">-- Select Teacher --</option>
                                    </select>
                                    <small class="text-muted">Optional - can be assigned later</small>
                                </div>
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-save"></i> Create Class
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-7">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Classes</h5>
                        </div>
                        <div class="card-body">
                            <div id="classesLoading" class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading classes...
                            </div>
                            <div class="table-responsive" id="classesTableContainer" style="display: none;">
                                <table class="table table-hover" id="classesList">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Class</th>
                                            <th>Form Teacher</th>
                                            <th>Students</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ASSIGNMENTS TAB -->
        <div class="tab-pane fade" id="assignmentsTab" role="tabpanel">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-link"></i> Assign Teacher to Class-Subject</h5>
                </div>
                <div class="card-body">
                    <form id="assignTeacherForm" class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label for="assignClass" class="form-label">Select Class *</label>
                            <select class="form-select" id="assignClass" required>
                                <option value="">-- Choose Class --</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="assignSubject" class="form-label">Select Subject *</label>
                            <select class="form-select" id="assignSubject" required>
                                <option value="">-- Choose Subject --</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="assignTeacher" class="form-label">Select Teacher *</label>
                            <select class="form-select" id="assignTeacher" required>
                                <option value="">-- Choose Teacher --</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-success w-100" style="margin-top: 32px;">
                                <i class="fas fa-save"></i> Assign
                            </button>
                        </div>
                    </form>

                    <!-- Assignments List -->
                    <hr>
                    <h6>Current Class-Subject Assignments</h6>
                    <div id="assignmentsList" class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i> Loading assignments...
                    </div>
                </div>
            </div>
        </div>

        <!-- RESULTS PDF TAB -->
        <div class="tab-pane fade" id="resultsTab" role="tabpanel">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-file-pdf"></i> Download Class Results PDF</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label for="pdfClassSelect" class="form-label">Select Class *</label>
                            <select class="form-select" id="pdfClassSelect" required>
                                <option value="">-- Choose Class --</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="pdfSessionSelect" class="form-label">Select Session *</label>
                            <select class="form-select" id="pdfSessionSelect" required>
                                <option value="">-- Choose Session --</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="pdfTermSelect" class="form-label">Select Term *</label>
                            <select class="form-select" id="pdfTermSelect" required>
                                <option value="">-- Choose Term --</option>
                                <option value="First">First Term</option>
                                <option value="Second">Second Term</option>
                                <option value="Third">Third Term</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-primary w-100" id="downloadPdfBtn"
                                style="margin-top: 32px;" title="Download simple broadsheet">
                                <i class="fas fa-download"></i> Broadsheet
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-success w-100" id="downloadComprehensivePdfBtn"
                                style="margin-top: 32px;" title="Download full result cards with traits">
                                <i class="fas fa-file-pdf"></i> Full Results
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-dark w-100" id="downloadCumulativeZipBtn"
                                style="margin-top: 32px;" title="Download Class Cumulative Session ZIP">
                                <i class="fas fa-file-archive"></i> Cumulative ZIP
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="alert alert-info mb-0">
                                <h6><i class="fas fa-list"></i> Broadsheet PDF</h6>
                                <small>Summary view with all students and their subject totals in a single
                                    table.</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-success mb-0">
                                <h6><i class="fas fa-file-alt"></i> Full Results PDF (Recommended)</h6>
                                <small>Individual result cards for each student including:
                                    <ul class="mb-0 mt-1">
                                        <li>Subject scores (CA1-CA4, Exam, Total, Grade)</li>
                                        <li>Affective & Psychomotor Traits</li>
                                        <li>Attendance, Class position</li>
                                        <li>Teacher & Principal comments</li>
                                        <li>Promotion status & Next term date</li>
                                    </ul>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Principal Comments Section -->
            <div class="card mt-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-comment"></i> Add Principal Comments</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle"></i> Before downloading full results, you can add Principal's
                        comment for each student. First select class, session, and term above.
                    </div>
                    <div id="principalCommentsContainer" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="principalCommentsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Student</th>
                                        <th>Average</th>
                                        <th>Position</th>
                                        <th>Principal's Comment</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <button type="button" class="btn btn-warning w-100" id="savePrincipalCommentsBtn">
                            <i class="fas fa-save"></i> Save Principal Comments
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Principal Comments Section omitted for brevity -->
    </div>

    <!-- SESSIONS TAB -->
    <div class="tab-pane fade" id="sessionsTab" role="tabpanel">
        <div class="row">
            <div class="col-md-5">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-plus"></i> Add Academic Session</h5>
                    </div>
                    <div class="card-body">
                        <form id="createSessionForm">
                            <div class="mb-3">
                                <label for="sessionName" class="form-label">Session Name *</label>
                                <input type="text" class="form-control" id="sessionName" placeholder="e.g., 2025/2026"
                                    required>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="sessionActive">
                                <label class="form-check-label" for="sessionActive">Set as Active Session</label>
                            </div>
                            <button type="submit" class="btn btn-success w-100"><i class="fas fa-save"></i> Create
                                Session</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-7">
                <div class="card">
                    <div class="card-header">
                        <h6>Existing Sessions</h6>
                    </div>
                    <div class="card-body">
                        <ul id="sessionsListGroup" class="list-group">
                            <!-- Loaded via JS -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ADD STUDENT TAB -->
    <div class="tab-pane fade" id="studentsMgmtTab" role="tabpanel">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-user-plus"></i> Register New Student</h5>
            </div>
            <div class="card-body">
                <form id="adminAddStudentForm" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">First Name *</label>
                        <input type="text" class="form-control" id="adminStudentFirstName" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Middle Name</label>
                        <input type="text" class="form-control" id="adminStudentMiddleName">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Last Name *</label>
                        <input type="text" class="form-control" id="adminStudentLastName" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Admission Number *</label>
                        <input type="text" class="form-control" id="adminStudentAdmission" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Target Class *</label>
                        <select class="form-select" id="adminStudentClass" required>
                            <option value="">-- Select Class --</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Gender *</label>
                        <select class="form-select" id="adminStudentGender" required>
                            <option value="M">Male</option>
                            <option value="F">Female</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Date of Birth</label>
                        <input type="date" class="form-control" id="adminStudentDOB">
                    </div>
                    <div class="col-12 text-end">
                        <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> Register
                            Student</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SETTINGS TAB -->
    <div class="tab-pane fade" id="settingsTab" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-signature"></i> Principal Signature</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Upload the principal's digital signature for result sheets.</p>
                        <div class="mb-3">
                            <label for="principalSignatureFile" class="form-label">Select Signature Image</label>
                            <input type="file" class="form-control" id="principalSignatureFile"
                                accept="image/png,image/jpeg,image/gif">
                            <small class="text-muted">Recommended: PNG with transparent background, max 2MB</small>
                        </div>
                        <div id="principalSignaturePreview" class="mb-3 text-center">
                            <p class="text-muted">No signature uploaded yet</p>
                        </div>
                        <button type="button" class="btn btn-primary w-100"
                            onclick="uploadSchoolSignature('principal_signature')">
                            <i class="fas fa-upload"></i> Upload Principal Signature
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-stamp"></i> School Stamp</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Upload the official school stamp for result sheets.</p>
                        <div class="mb-3">
                            <label for="schoolStampFile" class="form-label">Select Stamp Image</label>
                            <input type="file" class="form-control" id="schoolStampFile"
                                accept="image/png,image/jpeg,image/gif">
                            <small class="text-muted">Recommended: Square PNG with transparent background, max
                                2MB</small>
                        </div>
                        <div id="schoolStampPreview" class="mb-3 text-center">
                            <p class="text-muted">No stamp uploaded yet</p>
                        </div>
                        <button type="button" class="btn btn-secondary w-100" onclick="uploadSchoolSignature('stamp')">
                            <i class="fas fa-upload"></i> Upload School Stamp
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Edit Teacher Modal -->
<div class="modal fade" id="editTeacherModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Edit Teacher</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editTeacherForm">
                    <input type="hidden" id="editTeacherId">
                    <div class="mb-2"><label>First Name</label><input type="text" id="editTeacherFirstName"
                            class="form-control"></div>
                    <div class="mb-2"><label>Middle Name</label><input type="text" id="editTeacherMiddleName"
                            class="form-control"></div>
                    <div class="mb-2"><label>Last Name</label><input type="text" id="editTeacherLastName"
                            class="form-control"></div>
                    <div class="mb-2"><label>Staff ID</label><input type="text" id="editTeacherStaffId"
                            class="form-control"></div>
                    <div class="mb-2"><label>Phone</label><input type="text" id="editTeacherPhone" class="form-control">
                    </div>
                    <div class="mb-2"><label>New Password (leave blank to keep)</label><input type="password"
                            id="editTeacherPassword" class="form-control"></div>
                    <button type="submit" class="btn btn-primary w-100 mt-3">Update Teacher</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Subject Modal -->
<div class="modal fade" id="editSubjectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Edit Subject</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editSubjectForm">
                    <input type="hidden" id="editSubjectId">
                    <div class="mb-2"><label>Name</label><input type="text" id="editSubjectName" class="form-control">
                    </div>
                    <div class="mb-2"><label>Code</label><input type="text" id="editSubjectCode" class="form-control">
                    </div>
                    <button type="submit" class="btn btn-primary w-100 mt-3">Update Subject</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Class Modal -->
<div class="modal fade" id="editClassModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Edit Class</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editClassForm">
                    <input type="hidden" id="editClassId">
                    <div class="mb-2"><label>Name</label><input type="text" id="editClassName" class="form-control">
                    </div>
                    <div class="mb-2"><label>Form Teacher</label><select id="editClassTeacher"
                            class="form-select"></select></div>
                    <button type="submit" class="btn btn-primary w-100 mt-3">Update Class</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Load initial data
    document.addEventListener('DOMContentLoaded', async () => {
        await loadTeachers();
        await loadSubjects();
        await loadClasses();
        await loadSessions();
    });

    // ==================== TEACHERS ====================
    let allTeachers = []; // Store teachers globally for lookups

    async function loadTeachers() {
        try {
            const response = await fetch('/portal/api/admin/teachers/');
            const data = await response.json();
            allTeachers = data.teachers;
            const tbody = document.querySelector('#teachersList tbody');
            tbody.innerHTML = '';

            data.teachers.forEach(teacher => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${teacher.name}</td>
                    <td><code>${teacher.username}</code></td>
                    <td>${teacher.staff_id}</td>
                    <td>${teacher.phone || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="openEditTeacher(${teacher.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTeacher(${teacher.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('teachersLoading').style.display = 'none';
            document.getElementById('teachersTableContainer').style.display = 'block';

            // Update form teacher dropdowns
            const selects = [document.getElementById('formTeacher'), document.getElementById('editClassTeacher')];
            selects.forEach(select => {
                if (!select) return;
                select.innerHTML = '<option value="">-- Select Teacher --</option>';
                data.teachers.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.id;
                    option.textContent = teacher.name;
                    select.appendChild(option);
                });
            });

            // Update assign teacher dropdown
            const assignSelect = document.getElementById('assignTeacher');
            assignSelect.innerHTML = '<option value="">-- Choose Teacher --</option>';
            data.teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.id;
                option.textContent = teacher.name;
                assignSelect.appendChild(option);
            });
        } catch (error) {
            showAlert('danger', 'Error loading teachers: ' + error.message);
        }
    }

    window.openEditTeacher = function (id) {
        const t = allTeachers.find(x => x.id === id);
        if (!t) return;
        document.getElementById('editTeacherId').value = t.id;
        document.getElementById('editTeacherFirstName').value = t.first_name;
        document.getElementById('editTeacherMiddleName').value = t.middle_name || '';
        document.getElementById('editTeacherLastName').value = t.last_name;
        document.getElementById('editTeacherStaffId').value = t.staff_id;
        document.getElementById('editTeacherPhone').value = t.phone || '';
        new bootstrap.Modal(document.getElementById('editTeacherModal')).show();
    };

    document.getElementById('editTeacherForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('editTeacherId').value;
        const data = {
            first_name: document.getElementById('editTeacherFirstName').value,
            middle_name: document.getElementById('editTeacherMiddleName').value,
            last_name: document.getElementById('editTeacherLastName').value,
            staff_id: document.getElementById('editTeacherStaffId').value,
            phone: document.getElementById('editTeacherPhone').value,
            password: document.getElementById('editTeacherPassword').value
        };
        try {
            const resp = await fetch(`/portal/api/admin/teachers/${id}/edit/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
                body: JSON.stringify(data)
            });
            const res = await resp.json();
            if (res.success) {
                bootstrap.Modal.getInstance(document.getElementById('editTeacherModal')).hide();
                showAlert('success', 'Teacher updated');
                await loadTeachers();
            } else showAlert('danger', res.error);
        } catch (e) { showAlert('danger', e.message); }
    });

    window.deleteTeacher = async function (id) {
        if (!confirm('Are you sure you want to delete this teacher? This will also delete their login account.')) return;
        try {
            const resp = await fetch(`/portal/api/admin/teachers/${id}/delete/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
            });
            const res = await resp.json();
            if (res.success) { showAlert('success', 'Teacher deleted'); await loadTeachers(); }
            else showAlert('danger', res.error);
        } catch (e) { showAlert('danger', e.message); }
    };

    document.getElementById('createTeacherForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            username: document.getElementById('teacherUsername').value,
            first_name: document.getElementById('teacherFirstName').value,
            middle_name: document.getElementById('teacherMiddleName').value,
            last_name: document.getElementById('teacherLastName').value,
            staff_id: document.getElementById('teacherStaffId').value,
            password: document.getElementById('teacherPassword').value,
            phone: document.getElementById('teacherPhone').value
        };
        try {
            const response = await fetch('/portal/api/admin/teachers/create/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (result.success) {
                showAlert('success', 'Teacher created');
                document.getElementById('createTeacherForm').reset();
                await loadTeachers();
            } else showAlert('danger', result.error);
        } catch (error) { showAlert('danger', error.message); }
    });

    // ==================== SUBJECTS ====================
    let allSubjects = [];
    async function loadSubjects() {
        try {
            const response = await fetch('/portal/api/admin/subjects/');
            const data = await response.json();
            allSubjects = data.subjects;
            const tbody = document.querySelector('#subjectsList tbody');
            tbody.innerHTML = '';
            data.subjects.forEach(subject => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${subject.name}</strong></td>
                    <td><code>${subject.code || '-'}</code></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="openEditSubject(${subject.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSubject(${subject.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            document.getElementById('subjectsLoading').style.display = 'none';
            document.getElementById('subjectsTableContainer').style.display = 'block';
            const assignSelect = document.getElementById('assignSubject');
            assignSelect.innerHTML = '<option value="">-- Choose Subject --</option>';
            data.subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = subject.name;
                assignSelect.appendChild(option);
            });
        } catch (error) { showAlert('danger', error.message); }
    }

    window.openEditSubject = function (id) {
        const s = allSubjects.find(x => x.id === id);
        if (!s) return;
        document.getElementById('editSubjectId').value = s.id;
        document.getElementById('editSubjectName').value = s.name;
        document.getElementById('editSubjectCode').value = s.code || '';
        new bootstrap.Modal(document.getElementById('editSubjectModal')).show();
    };

    document.getElementById('editSubjectForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('editSubjectId').value;
        const data = {
            name: document.getElementById('editSubjectName').value,
            code: document.getElementById('editSubjectCode').value
        };
        try {
            const resp = await fetch(`/portal/api/admin/subjects/${id}/edit/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
                body: JSON.stringify(data)
            });
            const res = await resp.json();
            if (res.success) {
                bootstrap.Modal.getInstance(document.getElementById('editSubjectModal')).hide();
                showAlert('success', 'Subject updated');
                await loadSubjects();
            } else showAlert('danger', res.error);
        } catch (e) { showAlert('danger', e.message); }
    });

    window.deleteSubject = async function (id) {
        if (!confirm('Are you sure you want to delete this subject?')) return;
        try {
            const resp = await fetch(`/portal/api/admin/subjects/${id}/delete/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
            });
            const res = await resp.json();
            if (res.success) { showAlert('success', 'Subject deleted'); await loadSubjects(); }
            else showAlert('danger', res.error);
        } catch (e) { showAlert('danger', e.message); }
    };

    document.getElementById('createSubjectForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            name: document.getElementById('subjectName').value,
            code: document.getElementById('subjectCode').value
        };

        try {
            const response = await fetch('/portal/api/admin/subjects/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(data)
            });
            const result = await response.json();

            if (result.success) {
                showAlert('success', 'âœ“ Subject created successfully!');
                document.getElementById('createSubjectForm').reset();
                await loadSubjects();
            } else {
                showAlert('danger', result.error);
            }
        } catch (error) {
            showAlert('danger', 'Error: ' + error.message);
        }
    });

    // ==================== CLASSES ====================
    let allClasses = [];
    async function loadClasses() {
        try {
            const response = await fetch('/portal/api/admin/classes/');
            const data = await response.json();
            allClasses = data.classes;
            const tbody = document.querySelector('#classesList tbody');
            tbody.innerHTML = '';
            data.classes.forEach(cls => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${cls.name}</strong></td>
                    <td>${cls.form_teacher || '-'}</td>
                    <td><span class="badge bg-info">${cls.students}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="openEditClass(${cls.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteClass(${cls.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            document.getElementById('classesLoading').style.display = 'none';
            document.getElementById('classesTableContainer').style.display = 'block';
            ['assignClass', 'pdfClassSelect', 'adminStudentClass'].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.innerHTML = '<option value="">-- Choose Class --</option>';
                data.classes.forEach(cls => {
                    const opt = document.createElement('option');
                    opt.value = cls.id; opt.textContent = cls.name; el.appendChild(opt);
                });
            });
        } catch (error) { showAlert('danger', error.message); }
    }

    window.openEditClass = function (id) {
        const c = allClasses.find(x => x.id === id);
        if (!c) return;
        document.getElementById('editClassId').value = c.id;
        document.getElementById('editClassName').value = c.name;
        document.getElementById('editClassTeacher').value = c.form_teacher_id || '';
        new bootstrap.Modal(document.getElementById('editClassModal')).show();
    };

    document.getElementById('editClassForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('editClassId').value;
        const data = {
            name: document.getElementById('editClassName').value,
            form_teacher_id: document.getElementById('editClassTeacher').value
        };
        try {
            const resp = await fetch(`/portal/api/admin/classes/${id}/edit/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
                body: JSON.stringify(data)
            });
            const res = await resp.json();
            if (res.success) {
                bootstrap.Modal.getInstance(document.getElementById('editClassModal')).hide();
                showAlert('success', 'Class updated'); await loadClasses();
            } else showAlert('danger', res.error);
        } catch (e) { showAlert('danger', e.message); }
    });

    window.deleteClass = async function (id) {
        if (!confirm('Are you sure you want to delete this class?')) return;
        try {
            const resp = await fetch(`/portal/api/admin/classes/${id}/delete/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
            });
            const res = await resp.json();
            if (res.success) { showAlert('success', 'Class deleted'); await loadClasses(); }
            else showAlert('danger', res.error);
        } catch (e) { showAlert('danger', e.message); }
    };

    document.getElementById('createClassForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            name: document.getElementById('className').value,
            form_teacher_id: document.getElementById('formTeacher').value || null
        };
        try {
            const response = await fetch('/portal/api/admin/classes/create/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (result.success) {
                showAlert('success', 'Class created');
                document.getElementById('createClassForm').reset(); await loadClasses();
            } else showAlert('danger', result.error);
        } catch (error) { showAlert('danger', error.message); }
    });

    // ==================== SESSIONS ====================
    async function loadSessions() {
        try {
            const response = await fetch('/portal/api/sessions/');
            const data = await response.json();
            const select = document.getElementById('pdfSessionSelect');
            select.innerHTML = '<option value="">-- Choose Session --</option>';

            const listGroup = document.getElementById('sessionsListGroup');
            listGroup.innerHTML = '';

            data.sessions.forEach(session => {
                const option = document.createElement('option');
                option.value = session.id; option.textContent = session.name;
                select.appendChild(option);

                const item = document.createElement('li');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                item.innerHTML = `
                    <span>${session.name} ${session.is_active ? '<span class="badge bg-success">Active</span>' : ''}</span>
                `;
                listGroup.appendChild(item);
            });
        } catch (error) { console.error(error); }
    }

    document.getElementById('createSessionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            name: document.getElementById('sessionName').value,
            is_active: document.getElementById('sessionActive').checked
        };
        try {
            const resp = await fetch('/portal/api/admin/create-session/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
                body: JSON.stringify(data)
            });
            const res = await resp.json();
            if (res.success) {
                showAlert('success', 'Session created'); document.getElementById('createSessionForm').reset();
                await loadSessions();
            } else showAlert('danger', res.error);
        } catch (e) { showAlert('danger', e.message); }
    });

    // ==================== ADMIN ADD STUDENT ====================
    document.getElementById('adminAddStudentForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            class_id: document.getElementById('adminStudentClass').value,
            first_name: document.getElementById('adminStudentFirstName').value,
            middle_name: document.getElementById('adminStudentMiddleName').value,
            last_name: document.getElementById('adminStudentLastName').value,
            admission_number: document.getElementById('adminStudentAdmission').value,
            gender: document.getElementById('adminStudentGender').value,
            date_of_birth: document.getElementById('adminStudentDOB').value
        };
        try {
            const resp = await fetch('/portal/api/admin/add-student/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
                body: JSON.stringify(data)
            });
            const res = await resp.json();
            if (res.success) {
                showAlert('success', res.message); document.getElementById('adminAddStudentForm').reset();
                await loadClasses(); // refresh student count
            } else showAlert('danger', res.error);
        } catch (e) { showAlert('danger', e.message); }
    });

    // ==================== PDF DOWNLOAD ====================
    document.getElementById('downloadPdfBtn').addEventListener('click', async () => {
        const classId = document.getElementById('pdfClassSelect').value;
        const sessionId = document.getElementById('pdfSessionSelect').value;
        const term = document.getElementById('pdfTermSelect').value;

        if (!classId || !sessionId || !term) {
            showAlert('warning', 'Please select class, session, and term');
            return;
        }

        try {
            const downloadUrl = `/portal/admin/${classId}/results-pdf/?session_id=${sessionId}&term=${term}`;
            window.location.href = downloadUrl;
            showAlert('success', 'Downloading Broadsheet PDF...');
        } catch (error) {
            showAlert('danger', 'Error: ' + error.message);
        }
    });

    // ==================== COMPREHENSIVE PDF DOWNLOAD ====================
    document.getElementById('downloadComprehensivePdfBtn').addEventListener('click', async () => {
        const classId = document.getElementById('pdfClassSelect').value;
        const sessionId = document.getElementById('pdfSessionSelect').value;
        const term = document.getElementById('pdfTermSelect').value;

        if (!classId || !sessionId || !term) {
            showAlert('warning', 'Please select class, session, and term');
            return;
        }

        try {
            showAlert('info', 'Generating comprehensive result PDFs... This may take a moment.');
            const downloadUrl = `/portal/admin/${classId}/comprehensive-pdf/?session_id=${sessionId}&term=${term}`;
            window.location.href = downloadUrl;
            setTimeout(() => showAlert('success', 'Downloading Full Results ZIP...'), 1000);
        } catch (error) {
            showAlert('danger', 'Error: ' + error.message);
        }
    });

    // ==================== CUMULATIVE ZIP DOWNLOAD ====================
    document.getElementById('downloadCumulativeZipBtn').addEventListener('click', async () => {
        const classId = document.getElementById('pdfClassSelect').value;
        const sessionId = document.getElementById('pdfSessionSelect').value;

        if (!classId || !sessionId) {
            showAlert('warning', 'Please select class and session');
            return;
        }

        try {
            showAlert('info', 'Generating class cumulative ZIP... This may take a moment.');
            const downloadUrl = `/portal/admin/${classId}/cumulative-zip/?session_id=${sessionId}`;
            window.location.href = downloadUrl;
            setTimeout(() => showAlert('success', 'Downloading Cumulative Results ZIP...'), 1000);
        } catch (error) {
            showAlert('danger', 'Error: ' + error.message);
        }
    });

    // Load students for principal comments when selections change
    document.getElementById('pdfClassSelect').addEventListener('change', loadStudentsForComments);
    document.getElementById('pdfSessionSelect').addEventListener('change', loadStudentsForComments);
    document.getElementById('pdfTermSelect').addEventListener('change', loadStudentsForComments);

    async function loadStudentsForComments() {
        const classId = document.getElementById('pdfClassSelect').value;
        const sessionId = document.getElementById('pdfSessionSelect').value;
        const term = document.getElementById('pdfTermSelect').value;

        if (!classId || !sessionId || !term) {
            document.getElementById('principalCommentsContainer').style.display = 'none';
            return;
        }

        try {
            // Fetch term results to get student names and averages
            const response = await fetch(`/portal/api/term-results/?class_id=${classId}&session_id=${sessionId}&term=${term}`);
            const data = await response.json();

            if (data.success && data.results && data.results.length > 0) {
                const tbody = document.querySelector('#principalCommentsTable tbody');
                tbody.innerHTML = '';

                data.results.forEach(result => {
                    const row = document.createElement('tr');
                    row.dataset.studentId = result.student_id;
                    row.innerHTML = `
                        <td><strong>${result.student}</strong></td>
                        <td><span class="badge bg-info">${result.average}%</span></td>
                        <td><span class="badge bg-primary">${result.position}</span></td>
                        <td>
                            <input type="text" class="form-control principal-comment" 
                                   placeholder="Enter principal's comment..." 
                                   value="">
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                document.getElementById('principalCommentsContainer').style.display = 'block';
            } else {
                document.getElementById('principalCommentsContainer').style.display = 'none';
            }
        } catch (error) {
            console.error('Error loading students for comments:', error);
        }
    }

    // Save principal comments
    document.getElementById('savePrincipalCommentsBtn').addEventListener('click', async () => {
        const classId = document.getElementById('pdfClassSelect').value;
        const sessionId = document.getElementById('pdfSessionSelect').value;
        const term = document.getElementById('pdfTermSelect').value;

        const comments = [];
        document.querySelectorAll('#principalCommentsTable tbody tr').forEach(row => {
            const comment = row.querySelector('.principal-comment').value.trim();
            if (comment) {
                comments.push({
                    student_id: row.dataset.studentId,
                    principal_comment: comment
                });
            }
        });

        if (comments.length === 0) {
            showAlert('warning', 'Please enter at least one comment');
            return;
        }

        try {
            const response = await fetch(`/portal/admin/${classId}/principal-comments/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    session_id: sessionId,
                    term: term,
                    comments: comments
                })
            });

            const result = await response.json();

            if (result.success) {
                showAlert('success', `âœ“ ${result.message}`);
            } else {
                showAlert('danger', result.error || 'Failed to save comments');
            }
        } catch (error) {
            showAlert('danger', 'Error: ' + error.message);
        }
    });

    // ==================== UTILITIES ====================
    function showAlert(type, message) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert" style="margin-top: 10px;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        document.getElementById('alertContainer').innerHTML = alertHtml;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ==================== SIGNATURE UPLOAD ====================
    async function uploadSchoolSignature(type) {
        const fileInput = type === 'principal_signature'
            ? document.getElementById('principalSignatureFile')
            : document.getElementById('schoolStampFile');
        const previewId = type === 'principal_signature'
            ? 'principalSignaturePreview'
            : 'schoolStampPreview';

        const file = fileInput.files[0];
        if (!file) {
            showAlert('warning', 'Please select a file first');
            return;
        }

        const formData = new FormData();
        formData.append(type, file);

        try {
            const response = await fetch('/portal/api/signature/school/upload/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                showAlert('success', data.message);
                const url = type === 'principal_signature' ? data.principal_signature_url : data.stamp_url;
                if (url) {
                    document.getElementById(previewId).innerHTML =
                        `<img src="${url}" alt="${type}" style="max-width: 150px; max-height: 100px; border: 1px solid #ccc; padding: 5px;">`;
                }
            } else {
                showAlert('danger', data.error || 'Upload failed');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('danger', 'Upload failed: ' + error.message);
        }
    }

    // Preview files before upload
    document.getElementById('principalSignatureFile')?.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('principalSignaturePreview').innerHTML =
                    `<img src="${e.target.result}" alt="Preview" style="max-width: 150px; max-height: 100px; border: 1px dashed #ccc; padding: 5px;">`;
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('schoolStampFile')?.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('schoolStampPreview').innerHTML =
                    `<img src="${e.target.result}" alt="Preview" style="max-width: 100px; max-height: 100px; border: 1px dashed #ccc; padding: 5px;">`;
            };
            reader.readAsDataURL(file);
        }
    });
</script>{% endblock %}